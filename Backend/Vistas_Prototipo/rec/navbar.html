<style>
    .card {
        margin-top: 2vh;
        margin-bottom: 2vh;
        transition: .3s cubic-bezier(0.075, 0.82, 0.165, 1);
    }

    .card:hover {
        transform: scale3d(1.05, 1.05, 1.05);
    }
</style>
<script src="./js/validation.js"></script>
<script>
    $(function () {
        try {
            $.ajax({
                url: "http://localhost:4000/api/users/v1/profile", type: "GET",
                xhrFields: { withCredentials: true },
                crossDomain: true,
                success: function (data, status, request) {
                    $("#LoginButton").remove();
                    $("#User_Dropdown").append(userDropdown(data));
                    $("#User_Icon").append(getUserImage(data));
                    $("#navbar-list-items").append(getList("myList"))

                    $("#usernameModE").val(data.username);
                    $("#emailModE").val(data.email);

                    if (data.pubpriv) {
                        $("#PublicModE").parent().addClass("active");
                        $("#PublicModE").prop("checked", data.pubpriv);
                    } else {
                        $("#PrivateModE").parent().addClass("active");
                        $("#PrivateModE").prop("checked", !data.pubpriv);
                    }

                }, error: function (res, errorStatus, error) {
                }
            })
        } catch {

        }

        $(document).on("click", "#EditarUser", function () {
            $("#EditUserModal").modal('show')
        })

        $(document).on("click", "#LogOut", function () {
            $.ajax({
                url: "http://localhost:4000/api/users/v1/logOut", type: "GET",
                xhrFields: { withCredentials: true },
                crossDomain: true,
                success: function (data, status, request) {
                    alert("Se hizo el logout con exito");
                    window.location.reload();
                }, error: function (res, errorStatus, error) {
                    alert(res.responseJSON.status)
                }
            })
        })

        $(document).on("click", "#buttonDeleteUser", function () {
            if (confirm("¿Seguro que quiere eliminar su cuenta?")) {
                $.ajax({
                    url: "http://localhost:4000/api/users/", type: "DELETE",
                    xhrFields: { withCredentials: true },
                    crossDomain: true,
                    success: function (data, status, request) {
                        alert(data.status);
                        window.location.reload();
                    }, error: function (res, errorStatus, error) {
                        alert(res.responseJSON.status)
                    }
                })
            }
        })

        $(document).on("click", "#BtnSearch", function () {
            var text = $("#SearchText").val();
            var userList = $('#UserLists option:selected').val()
            if (userList == "Listas") {
                window.location.replace("./search.html?search=" + text)
            } else {
                window.location.replace("./searchuser.html?search=" + text)
            }
        })

    })
</script>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">PCNIVERSE</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul id="navbar-list-items" class="navbar-nav mr-auto">
            <li class="nav-item">
                <a class="nav-link" href="./index.html">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="./listas.html">Listas</a>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="./productos.html">Productos</a>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="./users.html">Usuarios</a>
            </li>

        </ul>
        <div class="form-inline my-2 my-lg-0">
            <select class="custom-select" name="UserLists" id="UserLists">
                <option value="Listas">Listas</option>
                <option value="Usuarios">Usuarios</option>
            </select>

            <input id="SearchText" class="form-control mr-sm-2" name="name" type="text" placeholder="Search"
                aria-label="Search">
            <button id="BtnSearch" class="btn btn-outline-success mr-sm-2 my-2 my-sm-0" type="submit">Search</button>
        </div>

        <button id="LoginButton" class="btn btn-outline-success mr-sm-2 my-2 my-sm-0" data-toggle="modal"
            data-target="#modalLRForm">Login</button>

        <div id="User_Dropdown" class="dropdown my-lg-0 mr-sm-2 my-2 my-sm-0">

        </div>

        <div id="User_Icon"></div>

    </div>
</nav>

<style>
    ::-webkit-scrollbar {
        width: 20px;
    }

    ::-webkit-scrollbar-track {
        -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: rgb(219, 223, 255);
        background: linear-gradient(0deg, rgba(219, 223, 255, 1) 0%, rgba(231, 255, 230, 1) 100%);
        border-radius: 10px;
        -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.5);
    }
</style>


<script>
    $(function () {
        $("#LoginFormulario").on("submit", function (e) {

            var form = $('#LoginFormulario').serialize();

            $.ajax({
                url: 'http://localhost:4000/api/users/logIn',
                data: form,
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                dataType: "JSON",
                xhrFields: { withCredentials: true },
                crossDomain: true,
                type: 'POST',
                success: function (data, status, request) {
                    $("#modalLRForm").modal("hide");
                    alert("Ingreso correctamente");
                    window.location.reload();
                },
                error: function (data, status, request) {
                    alert(data.responseJSON.status)
                }
            });

            e.preventDefault();
            return false;

        })

        $("#RegisterForm").on("submit", async function (e) {
            var validationSuccess = true;
            var form = $('#RegisterForm')[0];
            var formData = new FormData(form)

            var usernameR = $("#usernameR").val();
            var emailR = $("#emailR").val();
            var passwordR = $("#passwordR").val();
            var passwordRR = $("#passwordRR").val();

            if (!validate_length(usernameR, 3)) {
                validationSuccess = false;
                alert("Ingresa un username mayor o igual a 3 caracteres")
            }
            if (!validar_email(emailR)) {
                validationSuccess = false;
                alert('Ingresa una contraseña con 8 o más caracteres, que incluya una minuscula, una mayuscula y un caracter especial (!#"$%&/()=?¡¿)')
            }
            if (!validate_password(passwordR)) {
                validationSuccess = false;
                alert('Ingresa una contraseña con 8 o más caracteres, que incluya una minuscula, una mayuscula y un caracter especial (!#"$%&/()=?¡¿)')
            }
            if (passwordR != passwordR) {
                validationSuccess = false;
                alert("La contraseñas tienen que coincidir")
            }
            if ($("#fileAvatar").get(0).files.length === 0) {
                alert("Ingresa un avatar");
                validationSuccess = false;
            }
            if (validationSuccess) {
                await $.ajax({
                    url: 'http://localhost:4000/api/users/signUp',
                    data: formData,
                    dataType: "JSON",
                    xhrFields: { withCredentials: true },
                    crossDomain: true,
                    type: 'POST',
                    processData: false,
                    contentType: false,
                    success: function (data, status, request) {
                        alert("Ingreso correctamente");
                        window.location.reload();
                    },
                    error: function (data, status, request) {
                        alert(data.responseJSON.status)
                    }
                });
            }
            e.preventDefault();
            return false;
        })

        $("#formEditUser").on("submit", async function (e) {
            var validationSuccess = true;
            var form = $('#formEditUser')[0];
            var formData = new FormData(form)

            var usernameR = $("#usernameModE").val();
            var emailR = $("#emailModE").val();
            var passwordR = $("#passwordModE").val();

            if (!validate_length(usernameR, 3)) {
                validationSuccess = false;
                alert("Ingresa un username mayor o igual a 3 caracteres")
            }
            if (!validate_password(passwordR)) {
                validationSuccess = false;
                alert('Ingresa una contraseña con 8 o más caracteres, que incluya una minuscula, una mayuscula y un caracter especial (!#"$%&/()=?¡¿)')
            }
            if (!validar_email(emailR)) {
                validationSuccess = false;
                alert('Ingresa una contraseña con 8 o más caracteres, que incluya una minuscula, una mayuscula y un caracter especial (!#"$%&/()=?¡¿)')
            }
            if ($("#editImageUser").get(0).files.length === 0) {
                alert("Ingresa un avatar");
                validationSuccess = false;
            }
            if (validationSuccess) {
                await $.ajax({
                    url: 'http://localhost:4000/api/users/',
                    data: formData,
                    dataType: "JSON",
                    xhrFields: { withCredentials: true },
                    crossDomain: true,
                    type: 'PUT',
                    processData: false,
                    contentType: false,
                    success: function (data, status, request) {
                        debugger
                        $("#EditUserModal").modal("hide");
                        alert("Se edito correctamente");
                        window.location.reload();
                    },
                    error: function (data, status, request) {
                        alert(data.responseJSON.status)
                    }
                });
            }
            e.preventDefault();
            return false;
        })
    })

</script>

<div class="modal fade" id="modalLRForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-c-tabs">
                <ul class="nav nav-tabs md-tabs tabs-2 light-blue darken-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" href="#login" role="tab">Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#register" role="tab">Register</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade in show active" id="login" role="tabpanel">
                        <div class="modal-body">
                            <form method="post" id="LoginFormulario">
                                <div class="form-group">
                                    <label data-error="wrong" data-success="right" for="usernameEmailL">Nombre de
                                        usuario o email</label>
                                    <input type="text" name="identifier" id="usernameEmailL"
                                        class="form-control form-control-lg validate">
                                </div>
                                <div class="form-group">
                                    <label data-error="wrong" data-success="right" for="passwordL">Contraseña</label>
                                    <input type="password" name="password" id="passwordL"
                                        class="form-control form-control-lg validate">
                                </div>
                                <div class="form-group text-center">
                                    <button class="btn btn-info p-3">Ingresa</button>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <div class="options text-center text-md-right mt-1">
                                <p>¿Todavia no tienes cuenta? <a href="#" class="blue-text">Registrate</a></p>
                            </div>
                            <button type="button" class="btn btn-outline-info waves-effect ml-auto"
                                data-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="register" role="tabpanel">
                        <form id="RegisterForm" method="POST" class="modal-body">
                            <div class="form-group">
                                <label data-error="wrong" data-success="right" for="usernameR">Nombre de usuario</label>
                                <input type="text" id="usernameR" min="3" required name="username"
                                    class="form-control form-control-lg validate">
                            </div>
                            <div class="form-group">
                                <label data-error="wrong" data-success="right" for="emailR">Email</label>
                                <input type="email" name="email" required id="emailR"
                                    class="form-control form-control-lg validate">
                            </div>

                            <div class="form-group">
                                <label data-error="wrong" data-success="right" for="passwordR">Contraseña</label>
                                <input type="password" name="password" required id="passwordR"
                                    class="form-control form-control-lg validate">
                            </div>

                            <div class="form-group">
                                <label data-error="wrong" data-success="right" for="passwordRR">Repite la
                                    contraseña</label>
                                <input type="password" required id="passwordRR"
                                    class="form-control form-control-lg validate">
                            </div>

                            <div class="form-group">
                                <label data-error="wrong" data-success="right" for="fileAvatar">Ingresa un
                                    avatar</label>
                                <input name="image" accept="image/*" id="fileAvatar" type="file"
                                    onchange="validateImage('fileAvatar')" required
                                    class="form-control-file form-control-lg validate">
                            </div>

                            <div class="input-group mb-3">
                                <div class="input-group-text">
                                    <label for="seTiene">Publico o privado</label>
                                </div>
                                <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
                                    <label class="btn btn-secondary active">
                                        <input type="radio" value=true name="pubpriv" autocomplete="off" checked>
                                        Publico
                                    </label>
                                    <label class="btn btn-secondary">
                                        <input type="radio" value=false name="pubpriv" autocomplete="off">
                                        Privado
                                    </label>
                                </div>
                            </div>

                            <div class="text-center form-group">
                                <button class="btn btn-info p-3">Registrate</button>
                            </div>

                        </form>
                        <div class="modal-footer">
                            <div class="options text-right">
                                <p class="pt-1">¿Ya tienes una cuenta? <a href="#" class="blue-text">Ingresa</a></p>
                            </div>
                            <button type="button" class="btn btn-outline-info ml-auto"
                                data-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="EditUserModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar usuario</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="formEditUser" method="POST">
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text">Nombre</span>
                        </div>
                        <input id="usernameModE" type="text" name="name" class="form-control" required
                            aria-label="Default" aria-describedby="inputGroup-sizing-default">
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text">Email</span>
                        </div>
                        <input id="emailModE" type="text" name="email" class="form-control" required
                            aria-label="Default" aria-describedby="inputGroup-sizing-default">
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text">Contraseña</span>
                        </div>
                        <input id="passwordModE" type="password" name="password" class="form-control" required
                            aria-label="Default" aria-describedby="inputGroup-sizing-default">
                    </div>
                    <div class="input-group mb-3">
                        <div class="custom-file">
                            <input type="file" required name="image" accept="image/*" class="custom-file-input" id="editImageUser" onchange="validateImage('editImageUser')"
                                required>
                            <label class="custom-file-label" for="editImageUser">Escoge una imagen</label>
                        </div>
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-text">
                            <label for="PubPrivUserM">Publico o privado</label>
                        </div>
                        <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
                            <label class="btn btn-secondary active">
                                <input id="PublicModE" type="radio" value=true name="pubpriv" id="PubUserM" autocomplete="off" checked>
                                Publico
                            </label>
                            <label class="btn btn-secondary">
                                <input id="PrivateModE" type="radio" value=false name="pubpriv" id="PrivUserM" autocomplete="off">
                                Privado
                            </label>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary">Enviar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(".custom-file-input").on("change", function () {
        var fileName = $(this).val().split("\\").pop();
        $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
    });
</script>