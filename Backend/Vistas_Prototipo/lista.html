<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista</title>

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/lista.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="./js/helper.js"></script>
    <script>
        $(async function () {
            $("#navbar").load("./rec/navbar.html");
            $("#modList").load("./rec/navbar.html");
            $("#footer").load("./rec/footer.html");
            $("#modListDiv").load("./rec/modList.html");
            $("#modProductDiv").load("./rec/modProduct.html");

            var listaID = getUrlParameter("lista");
            var isMyList = false;
            if (!listaID) {
                debugger
                window.location.replace("./index.html")
            }

            await $.ajax({
                url: "http://localhost:4000/api/lists/isMyList/" + listaID, type: "GET",
                xhrFields: { withCredentials: true },
                crossDomain: true,
                success: function (data, status, request) {
                    if (data.isMyList) {
                        isMyList = true;
                    }
                }, error: function (res, errorStatus, error) { console.log(errorStatus) }
            })

            await $.ajax({
                url: "http://localhost:4000/api/lists/listproducts/" + listaID, type: "GET",
                xhrFields: { withCredentials: true },
                crossDomain: true,
                success: function (data, status, request) {
                    data.map(productos => {
                        $("#list-products-list").append(getProductsList(productos, isMyList));
                    })

                }, error: function (res, errorStatus, error) { console.log(errorStatus) }
            })

            if (isMyList) {
                $.get("./rec/emptyProduct.html", data => {
                    $("#list-products-list").append(data);
                });
            }

            $.ajax({
                url: "http://localhost:4000/api/lists/" + listaID, type: "GET",
                xhrFields: { withCredentials: true },
                crossDomain: true,
                success: function (data, status, request) {
                    if (data) {
                        $("#bigList").append(getBigList(data, isMyList))
                        $("#nameModInput").val(data.name);
                        $("#descModInput").val(data.desc);

                        $("#Privada").parent().removeClass("active");
                        $("#Publica").parent().removeClass("active");

                        if (data.pubpriv) {
                            $("#Publica").parent().addClass("active");
                            $("#Publica").prop("checked", data.pubpriv);
                        } else {
                            $("#Privada").parent().addClass("active");
                            $("#Privada").prop("checked", !data.pubpriv);
                        }
                    }
                    else {
                        debugger
                        window.location.replace("./index.html");
                    }
                }, error: function (res, errorStatus, error) {
                    console.log(errorStatus)
                    window.location.replace("./index.html");
                }
            })

            $(document).on("click", ".deleteList", function () {
                if (confirm("¿Seguro que quieres eliminar esta lista?")) {
                    $.ajax({
                        url: "http://localhost:4000/api/lists/" + listaID, type: "DELETE",
                        xhrFields: { withCredentials: true },
                        crossDomain: true,
                        success: function (data, status, request) {
                            alert("Se elimino la lista con exito")
                            debugger
                            window.location.replace("./index.html");
                        }, error: function (res, errorStatus, error) {
                            console.log(errorStatus)
                            alert(errorStatus)
                        }
                    })
                }
            })
            var idProduct = null
            $(document).on("click", ".modProduct",  function () {
                idProduct = $(this).attr('data-id');
                $.ajax({
                    url: "http://localhost:4000/api/products/" + idProduct, type: "GET",
                    xhrFields: { withCredentials: true },
                    crossDomain: true,
                    success: function (data, status, request) {

                        $("#nameModProduct").val(data.name);
                        $("#descModProduct").val(data.desc);

                        $("#SetieneMod").parent().removeClass("active");
                        $("#SeBuscaMod").parent().removeClass("active");

                        if (data.seTiene) {
                            $("#SetieneMod").parent().addClass("active");
                            $("#SetieneMod").prop("checked", data.pubpriv);
                        } else {
                            $("#SeBuscaMod").parent().addClass("active");
                            $("#SeBuscaMod").prop("checked", !data.pubpriv);
                        }

                    }, error: function (res, errorStatus, error) { 
                    }
                })
            })

            $(document).on("click", ".deleteProduct", function () {
                var idProduct = $(this).attr('data-id');

                if (confirm("¿Seguro que quieres eliminar este producto?")) {
                    $.ajax({
                        url: "http://localhost:4000/api/products/" + idProduct, type: "DELETE",
                        xhrFields: { withCredentials: true },
                        crossDomain: true,
                        success: function (data, status, request) {
                            alert("Se elimino el producto con exito")
                            debugger
                            window.location.reload();
                        }, error: function (res, errorStatus, error) {
                            console.log(errorStatus)
                            alert(errorStatus)
                        }
                    })
                }
            })

            $(document).on("submit", '#formModProduct', function (e) {

                var form = $('#formModProduct')[0]; // You need to use standard javascript object here
                var formData = new FormData(form);

                

                e.preventDefault();
                debugger
                $.ajax({
                    url: 'http://localhost:4000/api/products/' + idProduct,
                    data: formData,
                    type: 'PUT',
                    xhrFields: {
                        withCredentials: true
                    },
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        alert(data.status);
                        $("#ModProductModal").modal("hide");

                    },
                    error: function (res, errorStatus, error) {
                        alert("No se pudo modificar el producto, subiste un archivo que no es .png, .jpg, .gif o .jpeg o dejaste campos vacios");
                        $("#ModProductModal").modal("hide");
                    }
                });

            })
        })
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>
</head>

<body>
    <div id="navbar"></div>
    <div id="modListDiv"></div>
    <div id="modProductDiv"></div>

    <div class="row m-0 w-100">
        <div id="bigList" class="my-auto col-sm-12 col-lg-4">

        </div>
        <div id="items" class="col-sm-12 col-lg-8 ">
            <div id="list-products-list" class="row m-0 w-100">

            </div>
        </div>
    </div>
    <div class="mb-5"></div>
    <div id="footer"></div>

    <style>
        #items::-webkit-scrollbar {
            width: 10px;
        }

        /* #items::-webkit-scrollbar-track {
            -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        } */

        #items::-webkit-scrollbar-thumb {
            background: rgb(219, 223, 255);
            background: linear-gradient(0deg, rgba(219, 223, 255, 1) 0%, rgba(231, 255, 230, 1) 100%);
            border-radius: 10px;
            -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.5);
        }
    </style>
</body>

</html>